
<?php
// HEaderdatei
header("Content-type: text/html; charset=UTF-8");


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////    Include Files php          Es werden zugelcih Objekte mit Klassen generiert
/////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

require_once "../model/klassen/DP.php";
require_once "../allgemein/validierungen.php";;
require_once "../model/klassen/class_SqlTabelleKunden.php";

// Objekt Ticktarten instanzieren
$kunden = new class_SqlTabelleKunden();




////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////    Get Parameter         Zuerst wird der Get Parameter ausgewertet. In diesem Parameter ist der Username verschlüsselt. Dadurch ist klar, welcher username
/////////////////    auswerten             gesucht werden muss. Somit kann der richtige Bestätigungscode gesucht werden
/////////////////
/////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


$stringToArray = explode('_', $_GET['link']);
$username = $stringToArray[1];


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////    Datenbank lesen          Zuerst wird die Datenbank nach dem USer welcher im Link verschlüsselt ist durchsucht und dessen Kundendaten aus der
/////////////////                             Datenbank geladen, damit der abgespeicherte Bestätigungslink gesucht und gelesen werden kann
/////////////////
/////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// username nach  Bestätigungslink suchen
$userdaten = $kunden->Lesen("username", $username);


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////    Auswertung                 Auswerten ob Freigabelinks zusammenpassen. Wenn ja, dann das Flag in der Datenbank auf rue stellen, damit Account frei ist
/////////////////    Schreiben in
/////////////////    Datenbank
/////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// Freigabelink ist korrekt
if ($userdaten[0]["bestaetigungsCode"] === $_GET['link'] ) {


    // Der Account wird freigegeben - schreiben auf Datenbank
    $meldung = $kunden->Update(-1, ['loginFreigabe'], [1], "username", $username);

    // Meldung an User über Status
    if ($meldung === "true") {
        echo "Account ist freigeschaltet - Sie können dieses Fenster schliessen";
    }
    else {
        echo "Es ist ein Fehler aufgetreten. Versuchen Sie es nochmals";
        echo "<br>";
        echo $meldung;
    }
}
else {
    echo "links sind nicht übereinstimmend";
}



// loginFreigabe

?>

